<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ambulance Priority Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa7bf;
      --accent:#22c55e; --danger:#ef4444; --warn:#f59e0b;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#071029 0%, #071827 100%);color:#e6eef8}
    .container{max-width:1200px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;margin-top:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
          border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.03)}
    .status-card{grid-column:span 4}
    .main-card{grid-column:span 8}
    .lane-count{font-size:28px;font-weight:700}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
<div class="container">
<header>
  <div style="width:48px;height:48px;border-radius:10px;
              background:linear-gradient(180deg,#0ea5a9,#0284c7);
              display:flex;align-items:center;justify-content:center;font-weight:700">AI</div>
  <div>
    <h1>Ambulance Priority â€” Real-time Dashboard</h1>
    <p class="lead">Live visualization from AI Traffic System</p>
  </div>
  <div style="margin-left:auto;text-align:right">
    <div class="small">Connection</div>
    <div id="conn" style="font-weight:700;color:#f87171">DISCONNECTED</div>
  </div>
</header>

<div class="grid">
  <div class="card status-card">
    <h3>Total Vehicles</h3>
    <div class="lane-count" id="mainCount">-</div>
  </div>

  <div class="card status-card">
    <h3>Ambulance Detected</h3>
    <div class="lane-count" id="corridorCount">-</div>
  </div>

  <div class="card status-card">
    <h3>Traffic Mode</h3>
    <div class="lane-count" id="ambCount">-</div>
  </div>

  <div class="card main-card">
    <canvas id="vehiclesChart"></canvas>
  </div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const FLASK_URL = "/status";

const connEl = document.getElementById("conn");
const mainCountEl = document.getElementById("mainCount");
const corridorCountEl = document.getElementById("corridorCount");
const ambCountEl = document.getElementById("ambCount");

const ctx = document.getElementById("vehiclesChart").getContext("2d");

const vehiclesChart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: [
      { label: "Total Cars", data: [], borderColor:"#60a5fa", tension:0.3 },
      { label: "Estimated Side Cars", data: [], borderColor:"#34d399", tension:0.3 },
      { label: "Ambulance", data: [], borderColor:"#f97316", tension:0.3 }
    ]
  },
  options: {
    responsive:true,
    plugins:{legend:{labels:{color:'#c7d2fe'}}},
    scales:{x:{ticks:{color:'#9aa7bf'}},y:{ticks:{color:'#9aa7bf'}}}
  }
});

function updateUI(data) {
  mainCountEl.textContent = data.cars;
  corridorCountEl.textContent = data.ambulance ? "YES" : "NO";

  if (data.mode === "DYNAMIC" || data.mode === "AMBULANCE PRIORITY") {
    ambCountEl.textContent = data.mode;
    ambCountEl.style.color = "#ef4444";
  } else {
    ambCountEl.textContent = "STATIC";
    ambCountEl.style.color = "#22c55e";
  }

  const t = new Date().toLocaleTimeString();

  vehiclesChart.data.labels.push(t);
  vehiclesChart.data.datasets[0].data.push(data.cars);
  vehiclesChart.data.datasets[1].data.push(Math.max(0, data.cars - 2));
  vehiclesChart.data.datasets[2].data.push(data.ambulance ? 1 : 0);

  if (vehiclesChart.data.labels.length > 30) {
    vehiclesChart.data.labels.shift();
    vehiclesChart.data.datasets.forEach(d => d.data.shift());
  }
  vehiclesChart.update();
}

async function fetchFlaskData() {
  try {
    const res = await fetch(FLASK_URL, { cache: "no-store" });
    const data = await res.json();

    if (data.cars === undefined  data.ambulance === undefined  data.mode === undefined) {
      throw new Error("Invalid data");
    }

    connEl.textContent = "CONNECTED";
    connEl.style.color = "#86efac";
    updateUI(data);

  } catch (e) {
    connEl.textContent = "DISCONNECTED";
    connEl.style.color = "#f87171";
  }
}

setInterval(fetchFlaskData, 1000);
fetchFlaskData();
</script>
</body>
</html>
